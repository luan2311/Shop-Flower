@model ShopFlower.Models.DashboardViewModel
@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .chart-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

        .chart-card h4 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

    .date-filter {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

        .date-filter .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .date-filter label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }

        .date-filter input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

    #chartContainer {
        position: relative;
        min-height: 350px;
        padding: 10px 0;
    }
</style>

<div class="container-fluid">
    <!-- Summary Cards -->
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="icon" style="background-color: #e3342f;">
                        <i class="fas fa-book"></i>
                    </div>
                    <div>
                        <div class="text-value">@Model.TotalProducts</div>
                        <div class="text-muted">Tổng số sản phẩm</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="icon" style="background-color: #4dc0b5;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <div class="text-value">@Model.TotalUsers</div>
                        <div class="text-muted">Tổng người dùng</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="icon" style="background-color: #3490dc;">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div>
                        <div class="text-value">@Model.TodaysOrders</div>
                        <div class="text-muted">Đơn giao thành công</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="icon" style="background-color: #ffc107;">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div>
                        <div class="text-value">@Model.TotalRevenue.ToString("N0")</div>
                        <div class="text-muted">Tổng doanh thu</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transactions and Charts -->
    <div class="row">
        <div class="col-md-8">
            <div class="table-container">
                <h4>Đơn hàng gần đây</h4>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Mã HĐ</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in Model.RecentOrders)
                        {
                            <tr>
                                <td>@order.MaHD</td>
                                <td>@order.TAIKHOAN.TenHienThi</td>
                                <td>@order.NgayDat.ToString("dd/MM/yyyy")</td>
                                <td>@order.TongTien.ToString("N0")</td>
                                <td>
                                    @if (order.TrangThai == "Pending")
                                    {
                                        <span class="status-pending">@order.TrangThai</span>
                                    }
                                    else
                                    {
                                        <span class="status-completed">@order.TrangThai</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-4">
            <!-- Revenue Chart Section -->
            <div class="chart-card">
                <h4>Biểu đồ doanh thu</h4>
                <div class="date-filter">
                    <div class="form-group">
                        <label for="fromDate">Từ ngày</label>
                        <input type="date" id="fromDate" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="toDate">Đến ngày</label>
                        <input type="date" id="toDate" class="form-control" />
                    </div>
                </div>
                <div id="chartContainer">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!--Sản phẩm bán chạy-->
            <div class="table-container">
                <h4>Sản phẩm bán chạy</h4>
                <ul class="list-group list-group-flush">
                    @foreach (var product in Model.TopSellingProducts)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@product.ProductName</strong><br>
                                <small>Đã bán: @product.SL</small>
                            </div>
                            <span class="badge badge-primary badge-pill">@product.TotalSold.ToString("N0")</span>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
    var revenueChart;

        $(document).ready(function () {
      console.log('jQuery loaded:', typeof $ !== 'undefined');
   console.log('Chart.js loaded:', typeof Chart !== 'undefined');

            // Set default dates (last 30 days for better visualization)
      var today = new Date();
            var lastMonth = new Date(today);
  lastMonth.setDate(lastMonth.getDate() - 30);

            $('#toDate').val(formatDate(today));
       $('#fromDate').val(formatDate(lastMonth));

 console.log('Dates set:', $('#fromDate').val(), '-', $('#toDate').val());

      // Load initial chart
    loadRevenueChart();

    // Auto reload chart when date changes
      $('#fromDate, #toDate').on('change', function () {
    console.log('Date changed');
        loadRevenueChart();
            });
    });

        function formatDate(date) {
             var year = date.getFullYear();
    var month = String(date.getMonth() + 1).padStart(2, '0');
   var day = String(date.getDate()).padStart(2, '0');
    return year + '-' + month + '-' + day;
        }

        function loadRevenueChart() {
        var fromDate = $('#fromDate').val();
      var toDate = $('#toDate').val();
         console.log('Loading chart with dates:', fromDate, '-', toDate);
            if (!fromDate || !toDate) {
              console.log('Dates not set, returning');
       return;
  }

     var url = '@Url.Action("GetRevenueData", "Dashboard", new { area = "Admin" })';
            console.log('AJAX URL:', url);

   $.ajax({
 url: url,
   type: 'GET',
            data: {
  fromDate: fromDate,
        toDate: toDate
   },
       success: function (response) {
          console.log('AJAX response:', response);
     if (response.success) {
      renderChart(response.data);
     } else {
      console.error('Có lỗi xảy ra: ' + response.message);
            }
     },
   error: function (xhr, status, error) {
         console.error('Không thể tải dữ liệu biểu đồ:', error);
   console.error('Status:', status);
               console.error('Response:', xhr.responseText);
        }
     });
    }

        function renderChart(data) {
            console.log('Rendering chart with data:', data);
            var ctx = document.getElementById('revenueChart');

         if (!ctx) {
             console.error('Canvas element not found!');
          return;
       }

    ctx = ctx.getContext('2d');

      // Destroy existing chart if exists
 if (revenueChart) {
       revenueChart.destroy();
           }

  if (!data || data.length === 0) {
      console.log('No data to display');
  // Show empty state message
                return;
        }

    var labels = data.map(function (item) { return item.Date; });
     var revenues = data.map(function (item) { return item.Revenue; });

            console.log('Labels:', labels);
       console.log('Revenues:', revenues);

            // Create gradient
 var gradient = ctx.createLinearGradient(0, 0, 0, 350);
     gradient.addColorStop(0, 'rgba(74, 144, 226, 0.3)');
            gradient.addColorStop(0.5, 'rgba(74, 144, 226, 0.15)');
            gradient.addColorStop(1, 'rgba(74, 144, 226, 0.02)');

            revenueChart = new Chart(ctx, {
                type: 'line',
        data: {
     labels: labels,
            datasets: [{
    label: 'Doanh thu',
              data: revenues,
            backgroundColor: gradient,
     borderColor: '#4A90E2',
        borderWidth: 2.5,
 fill: true,
        tension: 0.4, // Smooth curve
           pointRadius: 3,
    pointBackgroundColor: '#4A90E2',
    pointBorderColor: '#fff',
    pointBorderWidth: 2,
       pointHoverRadius: 6,
   pointHoverBackgroundColor: '#4A90E2',
           pointHoverBorderColor: '#fff',
       pointHoverBorderWidth: 2
                }]
      },
         options: {
     responsive: true,
       maintainAspectRatio: false,
        interaction: {
     mode: 'index',
   intersect: false
   },
     plugins: {
          legend: {
              display: false
            },
          tooltip: {
      enabled: true,
         backgroundColor: 'rgba(0, 0, 0, 0.8)',
      padding: 12,
   titleColor: '#fff',
      titleFont: {
         size: 13,
        weight: '600'
    },
      bodyColor: '#fff',
          bodyFont: {
     size: 13
                 },
         borderColor: '#4A90E2',
  borderWidth: 1,
             displayColors: false,
           callbacks: {
            title: function(context) {
                return context[0].label;
        },
    label: function (context) {
          return new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNĐ';
 }
       }
          }
          },
       scales: {
   x: {
                 grid: {
              display: false
             },
      ticks: {
     font: {
      size: 11
        },
           color: '#666',
     maxRotation: 45,
     minRotation: 45
        }
  },
    y: {
    beginAtZero: true,
                grid: {
 color: 'rgba(0, 0, 0, 0.05)',
       drawBorder: false
    },
         ticks: {
            font: {
           size: 11
      },
              color: '#666',
    callback: function (value) {
   if (value >= 1000000) {
      return (value / 1000000).toFixed(1) + 'M';
                   } else if (value >= 1000) {
              return (value / 1000).toFixed(0) + 'K';
      }
         return value;
      }
       },
          border: {
      display: false
                  }
  }
                 }
          }
      });
    }
    </script>
}