@model ShopFlower.Models.DashboardViewModel
@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}


<div class="container-fluid">
    <!-- Summary Cards -->
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="icon" style="background-color: #e3342f;">
                        <i class="fas fa-book"></i>
                    </div>
                    <div>
                        <div class="text-value">@Model.TotalProducts</div>
                        <div class="text-muted">Tổng số sản phẩm</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="icon" style="background-color: #4dc0b5;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <div class="text-value">@Model.TotalUsers</div>
                        <div class="text-muted">Tổng người dùng</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="icon" style="background-color: #3490dc;">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div>
                        <div class="text-value">@Model.TodaysOrders</div>
                        <div class="text-muted">Đơn giao thành công</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card">
                <div class="card-body">
                    <div class="icon" style="background-color: #ffc107;">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div>
                        <div class="text-value">@Model.TotalRevenue.ToString("N0")</div>
                        <div class="text-muted">Tổng doanh thu</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transactions and Top Selling -->
    <div class="row">
        <div class="col-md-8">
            <div class="table-container">
                <h4>Đơn hàng gần đây</h4>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Mã HĐ</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in Model.RecentOrders)
                        {
                            <tr>
                                <td>@order.MaHD</td>
                                <td>@order.TAIKHOAN.TenHienThi</td>
                                <td>@order.NgayDat.ToString("dd/MM/yyyy")</td>
                                <td>@order.TongTien.ToString("N0")</td>
                                <td>
                                    @if (order.TrangThai == "Pending")
                                    {
                                        <span class="status-pending">@order.TrangThai</span>
                                    }
                                    else
                                    {
                                        <span class="status-completed">@order.TrangThai</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-4">
            <!-- Revenue Chart Section -->
            <div class="table-container">
                <h4>Biểu đồ doanh thu</h4>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="fromDate">Từ ngày:</label>
                        <input type="date" id="fromDate" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label for="toDate">Đến ngày:</label>
                        <input type="date" id="toDate" class="form-control" />
                    </div>
                </div>
                <div id="chartContainer" style="min-height: 400px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            <!--Sản phẩm bán chạy-->
            <div class="table-container" style=" margin-bottom: 30px;">
                <h4>Sản phẩm bán chạy</h4>
                <ul class="list-group list-group-flush">
                    @foreach (var product in Model.TopSellingProducts)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@product.ProductName</strong><br>
                                <small>Đã bán: @product.SL</small>
                            </div>
                            <span class="badge badge-primary badge-pill">@product.TotalSold.ToString("N0")</span>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>


</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
    var revenueChart;

        $(document).ready(function () {
            console.log('jQuery loaded:', typeof $ !== 'undefined');
            console.log('Chart.js loaded:', typeof Chart !== 'undefined');

            // Set default dates (last 7 days)
            var today = new Date();
            var lastWeek = new Date(today);
            lastWeek.setDate(lastWeek.getDate() - 7);

            $('#toDate').val(formatDate(today));
            $('#fromDate').val(formatDate(lastWeek));

            console.log('Dates set:', $('#fromDate').val(), '-', $('#toDate').val());

            // Load initial chart
            loadRevenueChart();

            // Auto reload chart when date changes
            $('#fromDate, #toDate').on('change', function () {
                console.log('Date changed');
                loadRevenueChart();
            });
        });

        function formatDate(date) {
             var year = date.getFullYear();
             var month = String(date.getMonth() + 1).padStart(2, '0');
             var day = String(date.getDate()).padStart(2, '0');
             return year + '-' + month + '-' + day;
        }

        function loadRevenueChart() {
           var fromDate = $('#fromDate').val();
           var toDate = $('#toDate').val();
            console.log('Loading chart with dates:', fromDate, '-', toDate);
            if (!fromDate || !toDate) {
              console.log('Dates not set, returning');
               return;
            }

            var url = '@Url.Action("GetRevenueData", "Dashboard", new { area = "Admin" })';
            console.log('AJAX URL:', url);

            $.ajax({
             url: url,
             type: 'GET',
            data: {
                    fromDate: fromDate,
                   toDate: toDate
            },
            success: function (response) {
            console.log('AJAX response:', response);
            if (response.success) {
                      renderChart(response.data);
            } else {
                     console.error('Có lỗi xảy ra: ' + response.message);
            }
          },
          error: function (xhr, status, error) {
                    console.error('Không thể tải dữ liệu biểu đồ:', error);
                 console.error('Status:', status);
               console.error('Response:', xhr.responseText);
                 }
          });
        }

        function renderChart(data) {
            console.log('Rendering chart with data:', data);
            var ctx = document.getElementById('revenueChart');

            if (!ctx) {
                console.error('Canvas element not found!');
                return;
            }

            ctx = ctx.getContext('2d');

            // Destroy existing chart if exists
           if (revenueChart) {
               revenueChart.destroy();
           }

            if (!data || data.length === 0) {
               console.log('No data to display');
                return;
            }

            var labels = data.map(function (item) { return item.Date; });
            var revenues = data.map(function (item) { return item.Revenue; });

            console.log('Labels:', labels);
            console.log('Revenues:', revenues);

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: revenues,
                    backgroundColor: 'rgba(52, 144, 220, 0.2)',
                    borderColor: 'rgba(52, 144, 220, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                        label: function (context) {
                        var label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNĐ';
                        return label;
                        }
                       }
                }
                         },
                 scales: {
                          y: {
                     beginAtZero: true,
                     ticks: {
                    callback: function (value) {
             return new Intl.NumberFormat('vi-VN').format(value);
              }
                 }
                           }
             }
                   }
            });

            console.log('Chart rendered successfully');
    }
    </script>
}